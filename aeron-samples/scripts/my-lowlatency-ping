#!/usr/bin/env bash
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
## https://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.
##

VERSION=$(cat ../../version.txt)

if [ -z "$1" ] || [ -z "$2" ]; then
  PING=aeron:udp?endpoint=pong:9000
  PONG=aeron:udp?endpoint=ping:9001
else
  PING=aeron:udp?endpoint=$2:9000
  PONG=aeron:udp?endpoint=$1:9001
fi
echo "Ping channel: $PING"
echo "Pong channel: $PONG"

${JAVA_HOME}/bin/java \
    -cp ../../aeron-all/build/libs/aeron-all-${VERSION}.jar \
    -XX:+UnlockExperimentalVMOptions \
    -XX:+TrustFinalNonStaticFields \
    -XX:+UnlockDiagnosticVMOptions \
    -XX:GuaranteedSafepointInterval=300000 \
    -XX:+UseParallelOldGC \
    -Daeron.sample.messages=100000 \
    -Daeron.sample.messageLength=32 \
    -Dagrona.disable.bounds.checks=true \
    -Daeron.pre.touch.mapped.memory=true \
    -Daeron.sample.exclusive.publications=true \
    "-Daeron.sample.ping.channel=${PING}" \
    "-Daeron.sample.pong.channel=${PONG}" \
    ${JVM_OPTS} io.aeron.samples.EmbeddedLowLatencyPing
